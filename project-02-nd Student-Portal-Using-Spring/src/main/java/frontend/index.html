<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* High Contrast + Neon Palette */
            --bg-deep: #020617;
            --sidebar-bg: rgba(15, 23, 42, 0.95);
            --card-bg: rgba(30, 41, 59, 0.75);
            --card-border: 1px solid rgba(148, 163, 184, 0.15);

            --primary: #38bdf8; /* Cyan */
            --secondary: #a78bfa; /* Purple */

            --text-main: #ffffff;
            --text-muted: #cbd5e1;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
        }

        /* --- 1. CUSTOM NEURAL CANVAS --- */
        #neural-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #020617 80%);
        }

        /* --- 2. CHROMATIC GLASSMORPHISM --- */
        .q-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: var(--card-border);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* Initial Shadow */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .q-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.4);
            /* THE CHROMATIC EFFECT: Splitting shadows into colors */
            box-shadow:
                -3px 0 0 rgba(255, 0, 0, 0.2),  /* Red Shift Left */
                 3px 0 0 rgba(0, 255, 255, 0.2), /* Cyan Shift Right */
                 0 10px 40px -10px rgba(0,0,0,0.5); /* Deep Shadow */
        }

        .stat-value {
            font-size: 2.5rem; font-weight: 700; color: white; margin: 10px 0;
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
        }
        .stat-label {
            color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
        }

        /* --- SIDEBAR (Fixed Visibility) --- */
        .q-sidebar {
            width: 260px;
            height: 100vh;
            position: fixed; left: 0; top: 0;
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column;
            z-index: 1000;
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }

        .brand-section {
            padding: 2rem 1.5rem; display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.1), transparent);
        }
        .brand-logo { font-size: 1.5rem; color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        .brand-text { font-weight: 700; font-size: 1.2rem; letter-spacing: 2px; color: white; }

        .nav-menu { padding: 20px 10px; flex: 1; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 20px;
            margin-bottom: 8px; border-radius: 12px;
            color: var(--text-muted); cursor: pointer; transition: 0.2s; font-weight: 500;
        }
        .nav-item i { width: 25px; font-size: 1.1rem; margin-right: 10px; }
        .nav-item:hover, .nav-item.active {
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.15), transparent);
            color: white; border-left: 3px solid var(--primary);
        }
        .nav-item.active i { color: var(--primary); text-shadow: 0 0 10px var(--primary); }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 260px; padding: 2.5rem; position: relative; z-index: 10; }

        /* --- TABLES --- */
        .q-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .q-table thead th {
            color: var(--primary); font-weight: 600; text-transform: uppercase;
            font-size: 0.8rem; padding: 10px 20px; letter-spacing: 1px;
        }
        .q-table tbody tr {
            background: rgba(30, 41, 59, 0.6); transition: 0.2s;
        }
        .q-table tbody tr:hover {
            background: rgba(56, 189, 248, 0.1); transform: scale(1.01);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
        }
        .q-table td {
            padding: 15px 20px; color: white; border: 1px solid transparent; vertical-align: middle;
        }
        .q-table td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .q-table td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        /* --- BUTTONS --- */
        .btn-glow {
            background: var(--primary); color: #000; font-weight: 700;
            padding: 10px 24px; border-radius: 8px; border: none;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); transition: 0.3s;
        }
        .btn-glow:hover {
            background: white; box-shadow: 0 0 25px rgba(56, 189, 248, 0.8); transform: translateY(-2px);
        }

        /* --- MODALS --- */
        .modal-content {
            background: #0f172a; border: 1px solid rgba(56, 189, 248, 0.3);
            color: white; border-radius: 16px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .modal-footer { border-top: 1px solid rgba(255,255,255,0.1); }
        .form-control, .form-select {
            background: #1e293b; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px;
        }
        .form-control:focus, .form-select:focus {
            background: #1e293b; color: white; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }
        label { color: var(--text-muted); margin-bottom: 5px; font-size: 0.9rem; }

    </style>
</head>
<body>

<canvas id="neural-canvas"></canvas>

<nav class="q-sidebar">
    <div class="brand-section">
        <i class="fas fa-atom brand-logo"></i>
        <span class="brand-text">QUANTUM</span>
    </div>

    <div class="nav-menu">
        <div class="nav-item active" onclick="switchView('dashboard', this)">
            <i class="fas fa-chart-pie"></i> Overview
        </div>
        <div class="nav-item" onclick="switchView('students', this)">
            <i class="fas fa-users"></i> Students
        </div>
        <div class="nav-item" onclick="switchView('courses', this)">
            <i class="fas fa-book"></i> Curriculum
        </div>
        <div class="nav-item" onclick="switchView('departments', this)">
            <i class="fas fa-building"></i> Sectors
        </div>
    </div>

    <div class="p-4 border-top border-secondary mt-auto" style="background: rgba(0,0,0,0.3)">
        <div class="d-flex align-items-center gap-3">
            <img src="https://ui-avatars.com/api/?name=Admin&background=38bdf8&color=fff" class="rounded-circle" width="40" style="border: 2px solid var(--primary); box-shadow: 0 0 10px var(--primary);">
            <div>
                <div class="fw-bold text-white small">System Admin</div>
                <div class="text-success small" style="font-size: 0.7rem; letter-spacing: 1px;">‚óè ONLINE</div>
            </div>
        </div>
    </div>
</nav>

<main class="main-content">

    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h2 class="fw-bold mb-1 text-white" style="letter-spacing: -1px;">Command Center</h2>
            <div class="text-muted small">Neural Interface Active</div>
        </div>
        <div class="q-card py-2 px-4 d-flex align-items-center gap-3" style="border-radius: 50px;">
            <i class="fas fa-clock text-primary"></i>
            <span id="liveClock" class="fw-bold font-monospace text-white">00:00:00</span>
        </div>
    </div>

    <div id="view-dashboard" class="view-section">
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="q-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Total Enrollment</div>
                            <div class="stat-value" id="stat-stu">0</div>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary border border-primary border-opacity-25">
                            <i class="fas fa-user-graduate fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="q-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Active Courses</div>
                            <div class="stat-value" id="stat-cour">0</div>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning border border-warning border-opacity-25">
                            <i class="fas fa-book fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="q-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Departments</div>
                            <div class="stat-value" id="stat-dept">0</div>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success border border-success border-opacity-25">
                            <i class="fas fa-building fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="q-card h-100">
                    <h5 class="mb-4 fw-bold text-white"><i class="fas fa-chart-bar me-2 text-primary"></i>Enrollment Analytics</h5>
                    <canvas id="mainChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="q-card h-100">
                    <h5 class="mb-4 fw-bold text-white"><i class="fas fa-chart-pie me-2 text-secondary"></i>Sector Share</h5>
                    <canvas id="subChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="view-students" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0 fw-bold text-white">Student Directory</h4>
            <button class="btn-glow" onclick="modalStudent()"><i class="fas fa-plus me-2"></i>New Student</button>
        </div>
        <div class="q-card p-0 overflow-hidden">
            <table class="q-table">
                <thead><tr><th>Name</th><th>Email</th><th>Level</th><th>Course</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="tb-students"></tbody>
            </table>
        </div>
    </div>

    <div id="view-courses" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0 fw-bold text-white">Course Management</h4>
            <button class="btn-glow" onclick="modalCourse()"><i class="fas fa-plus me-2"></i>New Course</button>
        </div>
        <div class="q-card p-0 overflow-hidden">
            <table class="q-table">
                <thead><tr><th>Course Name</th><th>Department ID</th><th>Semesters</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="tb-courses"></tbody>
            </table>
        </div>
    </div>

    <div id="view-departments" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0 fw-bold text-white">Departments</h4>
            <button class="btn-glow" onclick="modalDept()"><i class="fas fa-plus me-2"></i>New Department</button>
        </div>
        <div class="q-card p-0 overflow-hidden">
            <table class="q-table">
                <thead><tr><th>Department Name</th><th>System ID</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="tb-depts"></tbody>
            </table>
        </div>
    </div>

</main>

<div class="modal fade" id="md-student" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Student Details</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="s-id">
                <div class="mb-3"><label>Full Name</label><input class="form-control" id="s-name" placeholder="John Doe"></div>
                <div class="mb-3"><label>Email Address</label><input class="form-control" id="s-email" placeholder="john@example.com"></div>
                <div class="row g-2 mb-3"><div class="col"><label>Age</label><input type="number" class="form-control" id="s-age"></div><div class="col"><label>Semester</label><input type="number" class="form-control" id="s-sem" value="1"></div></div>
                <div class="mb-3"><label>Enrolled Course</label><select class="form-select" id="s-course"></select></div>
            </div>
            <div class="modal-footer"><button class="btn-glow w-100" onclick="apiSaveStudent()">Save Student</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="md-course" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Course Builder</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="c-id">
                <div class="row g-3 mb-4"><div class="col-md-6"><label>Course Name</label><input class="form-control" id="c-name"></div><div class="col-md-6"><label>Department</label><select class="form-select" id="c-dept"></select></div></div>
                <div id="c-sems" class="d-flex flex-column gap-3"></div>
                <button class="btn btn-outline-info w-100 mt-3" onclick="uiAddSem()">+ Add Semester Phase</button>
            </div>
            <div class="modal-footer"><button class="btn-glow" onclick="apiSaveCourse()">Save Curriculum</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="md-dept" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Department</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><input type="hidden" id="d-id"><label>Name</label><input class="form-control" id="d-name"></div>
            <div class="modal-footer"><button class="btn-glow w-100" onclick="apiSaveDept()">Save</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="md-view" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content"><div class="modal-header"><h5 class="modal-title">Academic Profile</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0" id="view-body"></div></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "http://localhost:8080";
    let chartA, chartB;

    // --- 1. CUSTOM NEURAL PHYSICS ENGINE ---
    const canvas = document.getElementById('neural-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];

    // Config
    const particleCount = 60;
    const connectionDist = 150;
    const mouseDist = 200;

    let mouse = { x: null, y: null };

    window.addEventListener('mousemove', e => {
        mouse.x = e.x;
        mouse.y = e.y;
    });

    window.addEventListener('resize', initCanvas);

    class Particle {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 0.5;
            this.vy = (Math.random() - 0.5) * 0.5;
            this.size = Math.random() * 2 + 1;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;

            // Bounce off walls
            if (this.x < 0 || this.x > width) this.vx *= -1;
            if (this.y < 0 || this.y > height) this.vy *= -1;

            // Mouse interaction
            let dx = mouse.x - this.x;
            let dy = mouse.y - this.y;
            let distance = Math.sqrt(dx*dx + dy*dy);
            if (distance < mouseDist) {
                const forceDirectionX = dx / distance;
                const forceDirectionY = dy / distance;
                const force = (mouseDist - distance) / mouseDist;
                const directionX = forceDirectionX * force * 0.5;
                const directionY = forceDirectionY * force * 0.5;
                this.vx += directionX;
                this.vy += directionY;
            }
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(56, 189, 248, 0.5)'; // Cyan particles
            ctx.fill();
        }
    }

    function initCanvas() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        particles = [];
        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }
    }

    function animate() {
        ctx.clearRect(0, 0, width, height);

        for (let i = 0; i < particles.length; i++) {
            particles[i].update();
            particles[i].draw();

            for (let j = i; j < particles.length; j++) {
                let dx = particles[i].x - particles[j].x;
                let dy = particles[i].y - particles[j].y;
                let distance = Math.sqrt(dx*dx + dy*dy);

                if (distance < connectionDist) {
                    ctx.beginPath();
                    ctx.strokeStyle = `rgba(56, 189, 248, ${1 - distance/connectionDist})`;
                    ctx.lineWidth = 1;
                    ctx.moveTo(particles[i].x, particles[i].y);
                    ctx.lineTo(particles[j].x, particles[j].y);
                    ctx.stroke();
                }
            }
        }
        requestAnimationFrame(animate);
    }

    // --- 2. APP LOGIC ---
    document.addEventListener("DOMContentLoaded", () => {
        initCanvas();
        animate();
        setInterval(() => document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(), 1000);
        loadDashboard();
    });

    function switchView(id, el) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.add('d-none'));
        document.getElementById(`view-${id}`).classList.remove('d-none');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');

        if(id === 'students') loadStudents();
        if(id === 'courses') loadCourses();
        if(id === 'departments') loadDepts();
    }

    async function loadDashboard() {
        const [s, c, d] = await Promise.all([
            fetch(`${API}/students`).then(r=>r.json()),
            fetch(`${API}/courses`).then(r=>r.json()),
            fetch(`${API}/departments`).then(r=>r.json())
        ]);

        document.getElementById('stat-stu').innerText = s.length;
        document.getElementById('stat-cour').innerText = c.length;
        document.getElementById('stat-dept').innerText = d.length;

        const counts = {};
        s.forEach(x => { const k = x.courseId || "Unassigned"; counts[k] = (counts[k]||0)+1; });
        const labels = Object.keys(counts).map(k => { const f = c.find(co=>co.id===k); return f?f.name:k; });
        const vals = Object.values(counts);

        if(chartA) chartA.destroy();
        chartA = new Chart(document.getElementById('mainChart'), {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Enrollment', data: vals, backgroundColor: '#38bdf8', borderRadius: 4 }] },
            options: { responsive: true, plugins: { legend: {display: false} }, scales: { y: { grid: {color:'rgba(255,255,255,0.1)'}, ticks: {color:'#cbd5e1'} }, x: { grid: {display:false}, ticks: {color:'#cbd5e1'} } } }
        });

        if(chartB) chartB.destroy();
        chartB = new Chart(document.getElementById('subChart'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data: vals, backgroundColor: ['#38bdf8', '#a78bfa', '#f472b6', '#fbbf24'], borderWidth: 0 }] },
            options: { responsive: true, plugins: { legend: {position: 'right', labels: {color:'#cbd5e1'}} } }
        });
    }

    function loadStudents() {
        fetch(`${API}/students`).then(r=>r.json()).then(d => {
            const b = document.getElementById("tb-students"); b.innerHTML = "";
            d.forEach(s => {
                b.innerHTML += `<tr>
                    <td class="fw-bold"><div class="d-flex align-items-center gap-3"><img src="https://ui-avatars.com/api/?name=${s.name}&background=38bdf8&color=fff" class="rounded-circle" width="30"> ${s.name}</div></td>
                    <td class="text-white-50">${s.email}</td>
                    <td><span class="badge bg-secondary">Sem ${s.currentSemester||1}</span></td>
                    <td class="text-info">${s.courseId||'-'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-light border-0" onclick="uiView('${s.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-outline-warning border-0" onclick="uiEditS('${s.id}')"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="apiDelS('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        });
    }

    function loadCourses(){ fetch(`${API}/courses`).then(r=>r.json()).then(d=>{ const b=document.getElementById("tb-courses"); b.innerHTML=""; d.forEach(c=>{ b.innerHTML+=`<tr><td class="fw-bold">${c.name}</td><td class="text-white-50">${c.departmentId}</td><td>${c.semesters?c.semesters.length:0}</td><td class="text-end"><button class="btn btn-sm btn-outline-warning border-0" onclick="uiEditC('${c.id}')"><i class="fas fa-pen"></i></button><button class="btn btn-sm btn-outline-danger border-0" onclick="apiDelC('${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }) }); }
    function loadDepts(){ fetch(`${API}/departments`).then(r=>r.json()).then(d=>{ const b=document.getElementById("tb-depts"); b.innerHTML=""; d.forEach(dp=>{ b.innerHTML+=`<tr><td class="fw-bold">${dp.name}</td><td class="text-white-50">${dp.id}</td><td class="text-end"><button class="btn btn-sm btn-outline-warning border-0" onclick="uiEditD('${dp.id}')"><i class="fas fa-pen"></i></button><button class="btn btn-sm btn-outline-danger border-0" onclick="apiDelD('${dp.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }) }); }

    // Helpers (Standardized for Modal Reuse)
    function modalStudent(s=null) {
        fetch(`${API}/courses`).then(r=>r.json()).then(cs=>{
            const sel=document.getElementById("s-course"); sel.innerHTML='<option value="">Select...</option>';
            cs.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
            document.getElementById("s-id").value=s?s.id:""; document.getElementById("s-name").value=s?s.name:"";
            document.getElementById("s-email").value=s?s.email:""; document.getElementById("s-age").value=s?s.age:"";
            document.getElementById("s-sem").value=s?(s.currentSemester||1):1; if(s) document.getElementById("s-course").value=s.courseId;
            new bootstrap.Modal(document.getElementById("md-student")).show();
        });
    }
    function apiSaveStudent(){ const id=document.getElementById("s-id").value, b={name:document.getElementById("s-name").value, email:document.getElementById("s-email").value, age:document.getElementById("s-age").value, currentSemester:document.getElementById("s-sem").value, courseId:document.getElementById("s-course").value}; fetch(id?`${API}/students/${id}`:`${API}/students`, {method:id?"PUT":"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(b)}).then(()=>{ bootstrap.Modal.getInstance(document.getElementById("md-student")).hide(); loadStudents(); }); }
    function uiEditS(id){ fetch(`${API}/students/${id}`).then(r=>r.json()).then(modalStudent); }
    function apiDelS(id){ if(confirm("Purge?")) fetch(`${API}/students/${id}`, {method:"DELETE"}).then(loadStudents); }

    function modalCourse(c=null){
        fetch(`${API}/departments`).then(r=>r.json()).then(ds=>{
            const sel=document.getElementById("c-dept"); sel.innerHTML='<option value="">Select...</option>';
            ds.forEach(d=>sel.innerHTML+=`<option value="${d.id}">${d.name}</option>`);
            document.getElementById("c-sems").innerHTML=''; document.getElementById("c-id").value=c?c.id:""; document.getElementById("c-name").value=c?c.name:"";
            if(c) document.getElementById("c-dept").value=c.departmentId;
            if(c&&c.semesters) c.semesters.forEach(sem=>{ const id=uiAddSem(sem.semesterNumber); if(sem.subjects) sem.subjects.forEach(sub=>uiAddSub(id, sub)); }); else uiAddSem(1);
            new bootstrap.Modal(document.getElementById("md-course")).show();
        });
    }
    function uiAddSem(n){ const c=document.getElementById("c-sems"), num=n||(c.children.length+1), id=Date.now()+Math.random(); c.insertAdjacentHTML('beforeend', `<div class="p-3 rounded bg-dark border border-secondary sem-b" id="sem-${id}"><div class="d-flex justify-content-between mb-2"><h6 class="text-info">Semester ${num}</h6><i class="fas fa-times text-danger" style="cursor:pointer" onclick="this.closest('.sem-b').remove()"></i></div><div id="sub-${id}" class="vstack gap-2"></div><button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="uiAddSub('${id}')">+ Subject</button></div>`); return id; }
    function uiAddSub(pid, s=null){ document.getElementById(`sub-${pid}`).insertAdjacentHTML('beforeend', `<div class="d-flex gap-2 sub-r"><input class="form-control form-control-sm" placeholder="Code" value="${s?s.code:''}"><input class="form-control form-control-sm" placeholder="Name" value="${s?s.name:''}"><input class="form-control form-control-sm" style="width:60px" placeholder="Cr" value="${s?s.credits:''}"><i class="fas fa-minus text-secondary align-self-center" onclick="this.parentElement.remove()"></i></div>`); }
    function apiSaveCourse(){ const sems=[]; document.querySelectorAll('.sem-b').forEach((el, i)=>{ const subs=[]; el.querySelectorAll('.sub-r').forEach(r=>{const inp=r.querySelectorAll('input'); if(inp[0].value) subs.push({code:inp[0].value, name:inp[1].value, credits:inp[2].value})}); sems.push({semesterNumber:i+1, subjects:subs}); }); const id=document.getElementById("c-id").value, b={name:document.getElementById("c-name").value, departmentId:document.getElementById("c-dept").value, semesters:sems}; fetch(id?`${API}/courses/${id}`:`${API}/courses`, {method:id?"PUT":"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(b)}).then(()=>{ bootstrap.Modal.getInstance(document.getElementById("md-course")).hide(); loadCourses(); }); }
    function uiEditC(id){ fetch(`${API}/courses/${id}`).then(r=>r.json()).then(modalCourse); }
    function apiDelC(id){ if(confirm("Decommission?")) fetch(`${API}/courses/${id}`, {method:"DELETE"}).then(loadCourses); }

    function modalDept(d=null){ document.getElementById("d-id").value=d?d.id:""; document.getElementById("d-name").value=d?d.name:""; new bootstrap.Modal(document.getElementById("md-dept")).show(); }
    function apiSaveDept(){ const id=document.getElementById("d-id").value; fetch(id?`${API}/departments/${id}`:`${API}/departments`, {method:id?"PUT":"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({name:document.getElementById("d-name").value})}).then(()=>{ bootstrap.Modal.getInstance(document.getElementById("md-dept")).hide(); loadDepts(); }); }
    function uiEditD(id){ fetch(`${API}/departments/${id}`).then(r=>r.json()).then(modalDept); }
    function apiDelD(id){ if(confirm("Del?")) fetch(`${API}/departments/${id}`, {method:"DELETE"}).then(loadDepts); }

    function uiView(id){ fetch(`${API}/students/${id}/full-details`).then(r=>r.json()).then(d=>{ let h = `<div class="p-4 bg-dark border-bottom border-secondary"><h4>${d.name}</h4><div class="text-white-50">${d.email}</div></div><div class="p-4 bg-dark">`; if(d.course&&d.course.semesters&&d.course.semesters.length>0){ const sem=d.course.semesters[0]; h+=`<h6 class="text-info mb-3">Enrolled: ${d.course.name} (Sem ${sem.semesterNumber})</h6><ul class="list-group list-group-flush bg-transparent">`; sem.subjects.forEach(s=>h+=`<li class="list-group-item bg-transparent text-white border-secondary d-flex justify-content-between"><span>${s.name} <small class="text-white-50">(${s.code})</small></span><span class="badge bg-secondary">${s.credits} Cr</span></li>`); h+=`</ul>`; } else { h+=`<div class="alert alert-dark border border-secondary text-white">No data for Sem ${d.currentSemester}</div>`; } document.getElementById("view-body").innerHTML=h+`</div>`; new bootstrap.Modal(document.getElementById("md-view")).show(); }); }

</script>
</body>
</html>